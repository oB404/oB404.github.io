<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Leak Test</title>
</head>
<body>
  <div>Request IP: <span id="ip"></span></div>
  <div id="rtc"></div>
  <script>
    const RTCPeerConnection =
      window['RTCPeerConnection'] ||
      window['mozRTCPeerConnection'] ||
      window['webkitRTCPeerConnection'];
    const ips = {};

    // Display the source IP address
    fetch('https://api.ipify.org/?format=json')
      .then(response => response.json())
      .then(data => {
        const ip = data.ip;
        document.getElementById('ip').textContent = ip;
        if (ip !== '65.15.220.7') {
          append('WebRTC Safe!');
        } else {
          append('WebRTC Leak!');
        }
      })
      .catch(error => console.error(error));

    function print(id, str) {
      const address = (/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/ ['exec'](str) || [])[1];
      if (ips[id] = ips[id] || [], address && -1 === ips[id]['indexOf'](address)) {
        ips[id]['push'](address);
        append(`RTC得到的真实IP - ${address}`);
      }
    }

    function ip(service, port = 3478) {
      if (void 0 !== RTCPeerConnection) {
        const pc = new RTCPeerConnection({
          iceServers: [{
            urls: "stun:" + service + ":" + port
          }]
        });
        pc['onicecandidate'] = ice => {
          ice['candidate'] && print(service, ice['candidate']['candidate'])
        };
        pc['createDataChannel']("");
        pc['createOffer'](result => {
          result['sdp']['split']("\n")['forEach'](line => {
            -1 !== line['indexOf']("candidate") && print(service, line)
          }), pc['setLocalDescription'](result, () => {}, () => {})
        }, () => {});
        setTimeout(() => {
          pc['localDescription'] && pc['localDescription']['sdp']['split']("\n")['filter'](l => 0 === l['indexOf']("a=candidate:"))['forEach'](line => print(service, line))
        }, 1e3)
        append(`WebRTC Leak: ${service}`);
      } else {
        append("WebRTC Safe!");
      }
    }

    function append(text) {
      const result = document.getElementById("rtc");
      const div = document.createElement("div");
      div.textContent = text;
      result.appendChild(div);
    }

    ip("stun4.l.google.com", 19302);
    ip("stun.voippro.com");
    ip("stun.voipraider.com");
  </script>
</body>
</html>
